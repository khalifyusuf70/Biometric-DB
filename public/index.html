<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JUBALAND STATEHOUSE FORCES DATABASE MANAGEMENT SYSTEM</title>
    <style>
        /* Your existing CSS remains exactly the same */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 10px 10px 0 0; }
        .header-content { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .logo { height: 60px; }
        .header-text { text-align: center; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { font-size: 16px; opacity: 0.9; }
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; padding: 20px; }
        .form-section { margin-bottom: 20px; }
        .form-section h3 { background: #34495e; color: white; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 16px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 8px 12px; border: 2px solid #bdc3c7; border-radius: 5px; font-size: 14px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: #3498db; outline: none; }
        input[readonly] { background-color: #ecf0f1; color: #7f8c8d; cursor: not-allowed; }
        .photo-section { background: #ecf0f1; padding: 20px; border-radius: 10px; text-align: center; height: fit-content; }
        .photo-upload { border: 2px dashed #bdc3c7; padding: 20px; border-radius: 10px; margin-bottom: 15px; cursor: pointer; transition: border-color 0.3s; }
        .photo-upload:hover { border-color: #3498db; }
        .photo-preview { width: 150px; height: 180px; background: white; border: 1px solid #bdc3c7; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .photo-preview img { max-width: 100%; max-height: 100%; display: none; }
        .upload-icon { font-size: 40px; color: #bdc3c7; margin-bottom: 10px; }
        .submit-btn { background: #3498db; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; display: block; margin: 10px 0; transition: background 0.3s; }
        .submit-btn:hover { background: #2980b9; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        .tabs { display: flex; background: #34495e; border-radius: 5px 5px 0 0; overflow: hidden; }
        .tab { padding: 15px 20px; cursor: pointer; border: none; background: none; color: white; flex: 1; text-align: center; transition: background 0.3s; }
        .tab.active { background: #3498db; }
        .tab:hover { background: #2980b9; }
        .content { display: none; }
        .content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; color: #2c3e50; }
        .alert { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <!-- Password Protection -->
    <div id="loginOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;display:flex;align-items:center;justify-content:center;">
        <div style="background:#2c3e50;color:white;padding:40px;border-radius:10px;text-align:center;box-shadow:0 0 20px rgba(0,0,0,0.3);">
            <h2 style="margin-bottom:20px;">üá∏üá¥ JUBALAND STATEHOUSE FORCES</h2>
            <h3 style="margin-bottom:20px;">Enter System Password</h3>
            <input type="password" id="passwordInput" placeholder="Enter password" style="padding:12px;margin:10px;width:250px;border-radius:5px;border:none;font-size:16px;">
            <br>
            <button onclick="checkPassword()" style="padding:12px 30px;background:#27ae60;color:white;border:none;border-radius:5px;cursor:pointer;font-size:16px;margin-top:10px;">Access System</button>
            <p style="margin-top:15px;font-size:12px;opacity:0.8;">Authorized Personnel Only</p>
        </div>
    </div>

    <div class="container">
        <!-- Header and all your HTML content remains exactly the same -->
        <!-- ... your existing HTML structure ... -->
    </div>

    <script>
        // Use absolute URL for API calls to avoid routing issues
        const API_BASE = window.location.origin + '/api';
        let photoBase64 = '';

        // Password Protection
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password === 'Jubaland2024') { 
                document.getElementById('loginOverlay').style.display = 'none';
            } else {
                alert('‚ùå Incorrect password! Access denied.');
                document.getElementById('passwordInput').value = '';
            }
        }
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        function showTab(tabName) {
            document.querySelectorAll('.content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Auto-fill Horin Commander based on Platoon selection
        function updateCommander() {
            const platoon = document.querySelector('[name="horin_platoon"]').value;
            const commanders = {
                'Horin1': 'Mohamed Abdi yusuf',
                'Horin2': 'Moge Hussein Guled', 
                'Horin3': 'Weli Fatule',
                'Horin4': 'Hareri Kulow Keynan',
                'Horin5': 'Blank1',
                'Horin6': 'Gowracdiid',
                'Taliska': 'Gowracdiid',
                'Fiat': 'Hiis Abdi Ali'
            };
            document.getElementById('horin_commander').value = commanders[platoon] || '';
        }

        // Auto-fill Salary based on Rank selection
        function updateSalary() {
            const rank = document.querySelector('[name="rank_position"]').value;
            const salaries = {
                'Askari': '200',
                'Taliye Unug': '250', 
                'Taliye Koox': '300',
                'Taliye Horin': '350',
                'Abandule': '450',
                'Taliye Guuto': '500'
            };
            document.getElementById('net_salary').value = salaries[rank] || '';
        }

        // Photo Upload Functionality
        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    alert('File size too large! Please select an image under 2MB.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('photoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.querySelector('.upload-icon').style.display = 'none';
                    photoBase64 = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        // Enhanced fetch with better error handling
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error(`Server returned HTML instead of JSON. Check if API route exists: ${url}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Register Soldier
        document.getElementById('soldierForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            data.photo = photoBase64;

            try {
                const result = await apiCall(`${API_BASE}/soldiers`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                const messageDiv = document.getElementById('formMessage');
                if (result.success) {
                    messageDiv.innerHTML = `<div class="alert success">Soldier registered successfully! ID: ${result.soldier.soldier_id}</div>`;
                    e.target.reset();
                    document.getElementById('photoPreview').style.display = 'none';
                    document.querySelector('.upload-icon').style.display = 'block';
                    photoBase64 = '';
                } else {
                    messageDiv.innerHTML = `<div class="alert error">Error: ${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('formMessage').innerHTML = `<div class="alert error">Network error: ${error.message}</div>`;
            }
        });

        // Load Soldiers
        async function loadSoldiers() {
            try {
                const result = await apiCall(`${API_BASE}/soldiers`);
                
                if (result.success) {
                    const soldiersHtml = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Rank</th>
                                    <th>Platoon</th>
                                    <th>Commander</th>
                                    <th>Salary</th>
                                    <th>Status</th>
                                    <th>Phone</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.soldiers.map(soldier => `
                                    <tr>
                                        <td><strong>${soldier.soldier_id}</strong></td>
                                        <td>${soldier.full_names}</td>
                                        <td>${soldier.rank_position}</td>
                                        <td>${soldier.horin_platoon}</td>
                                        <td>${soldier.horin_commander || 'N/A'}</td>
                                        <td>$${soldier.net_salary}</td>
                                        <td>${soldier.status}</td>
                                        <td>${soldier.tel_number}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('soldiersList').innerHTML = soldiersHtml;
                }
            } catch (error) {
                document.getElementById('soldiersList').innerHTML = `<div class="alert error">Error loading soldiers: ${error.message}</div>`;
            }
        }

        // Manual Verification
        async function manualVerification() {
            const soldierId = document.getElementById('manualSoldierId').value.trim();
            
            if (!soldierId) {
                alert('Please enter Soldier ID');
                return;
            }

            try {
                const result = await apiCall(`${API_BASE}/manual-verification`, {
                    method: 'POST',
                    body: JSON.stringify({ soldier_id: soldierId })
                });
                
                if (result.success) {
                    document.getElementById('manualResult').innerHTML = 
                        `<div class="alert success">‚úÖ ${result.message}<br>
                         Soldier: ${result.soldier.full_names}<br>
                         Time: ${new Date(result.soldier.verified_at).toLocaleString()}</div>`;
                    document.getElementById('manualSoldierId').value = '';
                } else {
                    document.getElementById('manualResult').innerHTML = 
                        `<div class="alert error">‚ùå ${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('manualResult').innerHTML = 
                    `<div class="alert error">‚ùå Network error: ${error.message}</div>`;
            }
        }

        // Load Today's Report
        async function loadTodayReport() {
            try {
                const result = await apiCall(`${API_BASE}/today-verifications`);
                
                if (result.success) {
                    let html = `<div class="alert info">`;
                    html += `<h4>üìä Daily Report - ${result.date}</h4>`;
                    html += `<p><strong>Total Soldiers:</strong> ${result.summary.total_soldiers}</p>`;
                    html += `<p><strong>Verified Today:</strong> ${result.summary.verified_today}</p>`;
                    html += `<p><strong>Missing Verification:</strong> ${result.summary.missing_verification}</p>`;
                    html += `</div>`;
                    
                    if (result.verifications.length > 0) {
                        html += `<table><tr><th>Soldier ID</th><th>Name</th><th>Rank</th><th>Platoon</th><th>Verification Time</th></tr>`;
                        result.verifications.forEach(verification => {
                            html += `<tr>
                                <td>${verification.soldier_id}</td>
                                <td>${verification.full_names}</td>
                                <td>${verification.rank_position}</td>
                                <td>${verification.horin_platoon}</td>
                                <td>${new Date(verification.verified_at).toLocaleString()}</td>
                            </tr>`;
                        });
                        html += `</table>`;
                    } else {
                        html += `<p>No verifications recorded for today.</p>`;
                    }
                    
                    document.getElementById('todayReport').innerHTML = html;
                }
            } catch (error) {
                document.getElementById('todayReport').innerHTML = 
                    `<div class="alert error">Error: ${error.message}</div>`;
            }
        }

        // Generate Payroll
        async function generatePayroll() {
            const month = document.getElementById('payrollMonth').value;
            const year = document.getElementById('payrollYear').value;
            
            try {
                const result = await apiCall(`${API_BASE}/monthly-payroll?month=${month}&year=${year}`);
                
                if (result.success) {
                    const report = result.report;
                    const payrollHtml = `
                        <div class="alert success">
                            <h3>Payroll Report - ${report.month}/${report.year}</h3>
                            <p>Total Soldiers: ${report.total_soldiers} | Total Salary: $${report.total_salary}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Rank</th>
                                    <th>Platoon</th>
                                    <th>Salary</th>
                                    <th>Verified At</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${report.soldiers.map(soldier => `
                                    <tr>
                                        <td>${soldier.soldier_id}</td>
                                        <td>${soldier.full_names}</td>
                                        <td>${soldier.rank_position}</td>
                                        <td>${soldier.horin_platoon}</td>
                                        <td>$${soldier.net_salary}</td>
                                        <td>${new Date(soldier.verified_at).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('payrollReport').innerHTML = payrollHtml;
                }
            } catch (error) {
                document.getElementById('payrollReport').innerHTML = `<div class="alert error">Error generating payroll: ${error.message}</div>`;
            }
        }

        // Load soldiers when tab is shown
        document.querySelector('[onclick="showTab(\'soldiers\')"]').addEventListener('click', loadSoldiers);
        // Load today's report when tab is shown
        document.querySelector('[onclick="showTab(\'verification\')"]').addEventListener('click', loadTodayReport);

        // Test API connection on load
        window.addEventListener('load', async () => {
            try {
                const result = await apiCall(`${API_BASE}/health`);
                console.log('API health check:', result);
            } catch (error) {
                console.error('API health check failed:', error);
            }
        });
    </script>
</body>
</html>
